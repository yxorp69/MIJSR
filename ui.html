<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MIJSR — Mini Runner</title>
<style>
  :root{font-family:system-ui,Segoe UI,Roboto,Arial}
  body{margin:12px;max-width:980px}
  header{display:flex;gap:8px;align-items:center;margin-bottom:8px}
  h1{font-size:16px;margin:0}
  .row{display:flex;gap:8px;align-items:center}
  input,button,textarea{font:inherit}
  input{padding:6px;border-radius:6px;border:1px solid rgba(0,0,0,.12)}
  button{padding:6px 10px;border-radius:8px;border:0;cursor:pointer}
  textarea{width:100%;height:260px;padding:8px;margin-top:8px;border-radius:8px;border:1px solid rgba(0,0,0,.12);box-sizing:border-box;font-family:ui-monospace,monospace}
  small{opacity:.7}
  #status{font-size:12px;color:#444;margin-top:8px}
  pre#log{background:#f6f6f6;padding:8px;border-radius:6px;max-height:160px;overflow:auto}
  code{background:#eee;padding:2px 6px;border-radius:4px}
</style>
</head>
<body>
  <header>
    <h1>MIJSR — Mini Runner</h1>
    <div style="margin-left:auto">
      <button id="closeBtn" title="Close popup">Close</button>
    </div>
  </header>

  <div class="row">
    <label style="flex:1">
      App name (just the name; e.g. <code>example</code>)
      <input id="app" placeholder="example" value="example" autocomplete="off">
    </label>
    <button id="fetchBtn">Fetch</button>
    <button id="runBtn">Run</button>
    <button id="copyBtn">Copy</button>
  </div>

  <div><small>Paste JS below to run custom script, or type an app name and press Run (it will fetch from <code>yxorp69/MIJSR/apps/&lt;name&gt;.js</code>).</small></div>
  <textarea id="code" placeholder="// your JS here — fetched script will appear here"></textarea>

  <div id="status" aria-live="polite"></div>
  <pre id="log" aria-live="polite"></pre>

<script>
(function(){
  const SECRET = '___MINI_RUN_SECRET___';
  const REPO_BASE = 'https://cdn.jsdelivr.net/gh/yxorp69/MIJSR@main/apps/';

  const $ = id => document.getElementById(id);
  const appEl = $('app'), codeEl = $('code');
  const fetchBtn = $('fetchBtn'), runBtn = $('runBtn'), copyBtn = $('copyBtn'), closeBtn = $('closeBtn');
  const statusEl = $('status'), logEl = $('log');

  function log(msg){
    logEl.textContent += msg + '\\n';
    logEl.scrollTop = logEl.scrollHeight;
  }
  function setStatus(msg, clearAfterMs){
    statusEl.textContent = msg || '';
    if(clearAfterMs){
      clearTimeout(setStatus._t);
      setStatus._t = setTimeout(()=> statusEl.textContent = '', clearAfterMs);
    }
  }
  function buildAppUrl(name){
    const n = (name||'').trim();
    if(!n) return '';
    if(!/^[A-Za-z0-9_-]+$/.test(n)) return '';
    return REPO_BASE + encodeURIComponent(n) + '.js';
  }

  async function fetchAndPopulate(){
    const name = appEl.value.trim();
    const url = buildAppUrl(name);
    if(!url){ alert('Invalid app name. Use simple name like: example'); return null; }
    setStatus('fetching: ' + url, 0);
    log('→ fetching ' + url);
    try{
      const r = await fetch(url, {cache:'no-store'});
      if(!r.ok) throw new Error(r.status + ' ' + r.statusText);
      const txt = await r.text();
      codeEl.value = txt;
      setStatus('fetched ✔', 1600);
      log('✔ fetched ' + name);
      return txt;
    }catch(e){
      codeEl.value = '// fetch error: ' + e;
      setStatus('fetch failed', 1600);
      log('✖ fetch failed: ' + e);
      return null;
    }
  }

  // Preferred execution: direct call into opener's __mijsr_exec (runs in page)
  function tryDirectExec(code){
    try{
      if(window.opener && !window.opener.closed && typeof window.opener.__mijsr_exec === 'function'){
        window.opener.__mijsr_exec(code);
        log('✔ executed via opener.__mijsr_exec (page context)');
        setStatus('executed in page', 1200);
        return true;
      }
    }catch(e){
      log('✖ direct exec failed: ' + e);
      // continue to fallback
    }
    return false;
  }

  // Fallback postMessage (opener must have the listener with matching SECRET)
  function tryPostMessage(code){
    try{
      if(window.opener && !window.opener.closed){
        window.opener.postMessage({ type: 'mini-run', secret: SECRET, code: code }, '*');
        log('→ posted code to opener via postMessage');
        setStatus('posted to opener', 1200);
        return true;
      }
    }catch(e){
      log('✖ postMessage to opener failed: ' + e);
    }
    return false;
  }

  // Last fallback: run inside popup
  function runInPopup(code){
    try{
      new Function(code)();
      log('✔ executed inside popup (fallback)');
      setStatus('ran in popup (fallback)', 2000);
    }catch(e){
      log('✖ execution error: ' + e);
      setStatus('execution error', 2000);
    }
  }

  fetchBtn.addEventListener('click', fetchAndPopulate);

  appEl.addEventListener('keydown', function(e){
    if(e.key === 'Enter' && !e.shiftKey){
      e.preventDefault();
      fetchBtn.click();
      setTimeout(()=> codeEl.focus(), 200);
    }
  });

  runBtn.addEventListener('click', async function(){
    let code = codeEl.value.trim();
    if(!code){
      setStatus('no code — fetching first...', 0);
      const fetched = await fetchAndPopulate();
      if(!fetched){ setStatus('abort: nothing to run', 1600); return; }
      code = codeEl.value;
    }
    // Try direct exec first, then postMessage, then local
    if(tryDirectExec(code)) return;
    if(tryPostMessage(code)) return;
    log('No opener available: running in popup (fallback).');
    runInPopup(code);
  });

  copyBtn.addEventListener('click', async ()=>{
    try{
      await navigator.clipboard.writeText(codeEl.value);
      log('Copied code to clipboard');
      setStatus('copied', 1200);
    }catch(e){
      log('✖ copy failed: ' + e);
    }
  });

  closeBtn.addEventListener('click', ()=> window.close());

  codeEl.addEventListener('keydown', (ev) => {
    if(ev.ctrlKey && ev.key === 'Enter') runBtn.click();
  });

  // allow opener to set app/code via postMessage if needed
  window.addEventListener('message', (e)=>{
    try{
      const d = e.data;
      if(d && d.type === 'mini-run-ctrl' && d.secret === SECRET){
        if(d.app) appEl.value = d.app;
        if(d.code) codeEl.value = d.code;
      }
    }catch(err){}
  });

  try{ appEl.select(); }catch(e){}
})();
</script>
</body>
</html>
